<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/favicon/manifest.json">
  <meta name="google-site-verification" content="Qw4beUdi9l3fPhazbrJKcO9VcGWuWFHjBwL2YXsV9FU">
  <meta name="msvalidate.01" content="DCD6E61D797D51CEBCD35C313C708277">
  <meta name="yandex-verification" content="4d238d70128aa114">
  <meta name="baidu-site-verification" content="M3sM0Zbhyh">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.boris1993.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.21.1","exturl":true,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"waline","storage":true,"lazyload":false,"nav":null,"activeClass":"waline"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"BP1VV29KGV","apiKey":"e96b072abb03747b3fbf7b25a408dce3","indexName":"blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="昨天面试的时候被问到 Java 中的 synchronized 关键字是什么原理，虽然凭着记忆打出来是通过控制对象头的 Monitor 来实现，但是毕竟没吃透这个知识点，还是没啥底气。干脆，这次就从字节码上看看，用了 synchronized 关键字的方法，到底是怎么执行的。">
<meta property="og:type" content="article">
<meta property="og:title" content="从字节码看 synchronized 关键字是怎么工作的">
<meta property="og:url" content="https://www.boris1993.com/how-synchronized-works-in-java.html">
<meta property="og:site_name" content="Code Life">
<meta property="og:description" content="昨天面试的时候被问到 Java 中的 synchronized 关键字是什么原理，虽然凭着记忆打出来是通过控制对象头的 Monitor 来实现，但是毕竟没吃透这个知识点，还是没啥底气。干脆，这次就从字节码上看看，用了 synchronized 关键字的方法，到底是怎么执行的。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-static.boris1993.com/how-synchronized-works-in-java/java_object_memory_allocation.png">
<meta property="article:published_time" content="2023-04-05T07:22:04.000Z">
<meta property="article:modified_time" content="2024-11-18T16:36:26.830Z">
<meta property="article:author" content="Boris Zhao">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="面试问题">
<meta property="article:tag" content="syncronized">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-static.boris1993.com/how-synchronized-works-in-java/java_object_memory_allocation.png">


<link rel="canonical" href="https://www.boris1993.com/how-synchronized-works-in-java.html">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.boris1993.com/how-synchronized-works-in-java.html","path":"how-synchronized-works-in-java.html","title":"从字节码看 synchronized 关键字是怎么工作的"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>从字节码看 synchronized 关键字是怎么工作的 | Code Life</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JJTESLRX7L"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-JJTESLRX7L","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?35c0dde4dcb72e943e5fd12fe7cd8bf0"></script>


  <script data-pjax defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{&quot;token&quot;: &quot;e5bcb451049d4b529efd7ecdab37dbc5&quot;}'></script>



  <script async defer data-website-id="93d2d7ff-da5c-45eb-8af7-4def0f4a7c29" src="https://umami.boris1993.com/script.js"></script>

<link rel="dns-prefetch" href="https://valine-api.boris1993.com"><script>
    const mainSiteUrl = "https://www.boris1993.com";
    const bypassRedirectionQueryParam = "bypassRedirection";

    let shouldBypassRedirection = false;

    let searchParams = new URLSearchParams(window.location.search);
    shouldBypassRedirection = searchParams.get(bypassRedirectionQueryParam) == "1";

    // Redirect to the main site from other sites like GitHub pages or GitEE pages
    if (!location.href.match("http(s{0,1}):\/\/(localhost|www.boris1993.com)") && !shouldBypassRedirection) {
        location.href = mainSiteUrl + location.pathname;
    }
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1056823357231661" crossorigin="anonymous"></script>

<!-- Vercel Web Analytics -->
<script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
<!-- Vercel Web Analytics -->

<!-- Vercel Speed Insights -->
<script>
    window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
</script>
<script defer src="/_vercel/speed-insights/script.js"></script>
<!-- Vercel Speed Insights -->

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/rss2.xml" title="Code Life" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Code Life</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">boris1993的个人博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li><li class="menu-item menu-item-探针"><span class="exturl" data-url="aHR0cHM6Ly9uZXpoYS5ib3JpczE5OTMuY29tLw=="><i class="fa fa-link fa-fw"></i>探针</span></li><li class="menu-item menu-item-领支付宝红包"><span class="exturl" data-url="aHR0cHM6Ly96ZmJoYi5ib3JpczE5OTMuY29tLw=="><i class="fa-brands fa-alipay fa-fw"></i>领支付宝红包</span></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fab fa-algolia fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-number">1.</span> <span class="nav-text">示例代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91%E6%88%90%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-number">2.</span> <span class="nav-text">反编译成字节码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java%E5%AF%B9%E8%B1%A1%E5%A4%B4%E5%92%8CMonitor"><span class="nav-number">3.</span> <span class="nav-text">Java 对象头和 Monitor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%A7%E7%BB%AD%E6%B7%B1%E5%85%A5%E7%BB%86%E8%8A%82"><span class="nav-number">4.</span> <span class="nav-text">继续深入细节</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-number">5.</span> <span class="nav-text">参考文章</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Boris Zhao"
      src="/images/favicon/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Boris Zhao</p>
  <div class="site-description" itemprop="description">Boris has arrived!</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">114</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">171</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JvcmlzMTk5Mw==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;boris1993"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9ib3Jpc196aGFvXzkz" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;boris_zhao_93"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL2JvcmlzLnpoYW8uOTM=" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;boris.zhao.93"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS91c2Vycy8zODMzODU4L2JvcmlzMTk5Mw==" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;3833858&#x2F;boris1993"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vQGJvcmlzMTk5Mw==" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;@boris1993"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS9ib3Jpcy56aGFv" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;boris.zhao"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_sa.svg" alt="Creative Commons"></span>
  </div>
<!-- sidebar ad 
<div class="sidebar-adsense">
     <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-1056823357231661"
          data-ad-slot="1718521250"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
     <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
     </script>
</div>
-->
        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.boris1993.com/how-synchronized-works-in-java.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon/avatar.jpeg">
      <meta itemprop="name" content="Boris Zhao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code Life">
      <meta itemprop="description" content="Boris has arrived!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="从字节码看 synchronized 关键字是怎么工作的 | Code Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          从字节码看 synchronized 关键字是怎么工作的
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-05 15:22:04" itemprop="dateCreated datePublished" datetime="2023-04-05T15:22:04+08:00">2023-04-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-11-19 00:36:26" itemprop="dateModified" datetime="2024-11-19T00:36:26+08:00">2024-11-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/learning/" itemprop="url" rel="index"><span itemprop="name">学知识</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/how-synchronized-works-in-java.html#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/how-synchronized-works-in-java.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="waline-pageview-count" data-path="/how-synchronized-works-in-java.html"></span>
    </span>
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>昨天面试的时候被问到 Java 中的 <code>synchronized</code> 关键字是什么原理，虽然凭着记忆打出来是通过控制对象头的 Monitor 来实现，但是毕竟没吃透这个知识点，还是没啥底气。干脆，这次就从字节码上看看，用了 <code>synchronized</code> 关键字的方法，到底是怎么执行的。</p>
<span id="more"></span>

<h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><p>说起 <code>synchronized</code> 的最简单的使用场景，我马上就想起双检单例模式。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Test INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Test</span><span class="params">()</span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Test <span class="title function_">getInstance</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">synchronized</span> (Test.class) {</span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) {</span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"test"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="反编译成字节码"><a href="#反编译成字节码" class="headerlink" title="反编译成字节码"></a>反编译成字节码</h2><p>把 <code>Test</code> 类先编译了，然后用 <code>javap -c Test.class</code> 反编译，就能看到这个类的字节码了。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Compiled from <span class="string">"Test.java"</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Test <span class="title function_">getInstance</span><span class="params">()</span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: getstatic     #<span class="number">7</span>                  <span class="comment">// 把静态变量INSTANCE加载到栈</span></span><br><span class="line">       <span class="number">3</span>: ifnonnull     <span class="number">37</span>                  <span class="comment">// 如果值不是null，那么跳转到标签37</span></span><br><span class="line">       <span class="number">6</span>: ldc           #<span class="number">8</span></span><br><span class="line">       <span class="number">8</span>: dup</span><br><span class="line">       <span class="number">9</span>: astore_0</span><br><span class="line">      <span class="number">10</span>: monitorenter                      <span class="comment">// 进入synchronized块</span></span><br><span class="line">      <span class="number">11</span>: getstatic     #<span class="number">7</span>                  <span class="comment">// 把静态变量INSTANCE加载到栈</span></span><br><span class="line">      <span class="number">14</span>: ifnonnull     <span class="number">27</span>                  <span class="comment">// 如果值不是null，那么跳转到标签27</span></span><br><span class="line">      <span class="number">17</span>: <span class="keyword">new</span>           #<span class="number">8</span>                  <span class="comment">// new一个Test对象</span></span><br><span class="line">      <span class="number">20</span>: dup</span><br><span class="line">      <span class="number">21</span>: invokespecial #<span class="number">13</span>                 <span class="comment">// 执行构造函数</span></span><br><span class="line">      <span class="number">24</span>: putstatic     #<span class="number">7</span></span><br><span class="line">      <span class="number">27</span>: aload_0</span><br><span class="line">      <span class="number">28</span>: monitorexit                       <span class="comment">// 退出synchronized块</span></span><br><span class="line">      <span class="number">29</span>: goto          <span class="number">37</span></span><br><span class="line">      <span class="number">32</span>: astore_1</span><br><span class="line">      <span class="number">33</span>: aload_0</span><br><span class="line">      <span class="number">34</span>: monitorexit</span><br><span class="line">      <span class="number">35</span>: aload_1</span><br><span class="line">      <span class="number">36</span>: athrow</span><br><span class="line">      <span class="number">37</span>: getstatic     #<span class="number">7</span>                  <span class="comment">// Field INSTANCE:LTest;</span></span><br><span class="line">      <span class="number">40</span>: areturn</span><br><span class="line">    Exception table:</span><br><span class="line">       from    to  target type</span><br><span class="line">          <span class="number">11</span>    <span class="number">29</span>    <span class="number">32</span>   any</span><br><span class="line">          <span class="number">32</span>    <span class="number">35</span>    <span class="number">32</span>   any</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: getstatic     #<span class="number">14</span>                 <span class="comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">       <span class="number">3</span>: ldc           #<span class="number">20</span>                 <span class="comment">// String test</span></span><br><span class="line">       <span class="number">5</span>: invokevirtual #<span class="number">22</span>                 <span class="comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">       <span class="number">8</span>: <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意看 <code>10: monitorenter</code> 和 <code>28: monitorexit</code> 这两条字节码，这就是 <code>synchronized</code> 关键字实际做了的事。</p>
<h2 id="Java对象头和Monitor"><a href="#Java对象头和Monitor" class="headerlink" title="Java对象头和Monitor"></a>Java 对象头和 Monitor</h2><p>要说明白 <code>monitorenter</code> 和 <code>monitorexit</code> 实际干了点啥，那就得先整明白 Java 对象的对象头。</p>
<p>一个 Java 对象，在内存中的布局包括三块区域：对象头、实例数据、和对齐填充。</p>
<p><img data-src="https://blog-static.boris1993.com/how-synchronized-works-in-java/java_object_memory_allocation.png"></p>
<p>别的东西咱们先不看，只看对象头这部分。对象头的最后 2bit 就存储了锁的标志位。</p>
<p>至于 Monitor，Java 官方文档是这么描述的：</p>
<blockquote>
<p>Synchronization is built around an internal entity known as the intrinsic lock or monitor lock. (The API specification often refers to this entity simply as a “monitor.”) Intrinsic locks play a role in both aspects of synchronization: enforcing exclusive access to an object’s state and establishing happens-before relationships that are essential to visibility.</p>
<p>Every object has an intrinsic lock associated with it. By convention, a thread that needs exclusive and consistent access to an object’s fields has to acquire the object’s intrinsic lock before accessing them, and then release the intrinsic lock when it’s done with them. </p>
<p>同步是围绕着一个名为 “内在锁” 或 “monitor 锁” 的机制构建的。（API 规范文档中，通常会称其为 “monitor”）<br>内在锁一方面保证了针对一个对象的专属访问权限，另一方面保证了对可见性很重要的 happens-before 原则。<br>每个对象都会有一个与其相关联的内在锁。按照约定，如果一个线程需要持续持有对一个对象的独家访问权限，那么这个线程必须先获得到这个对象的内在锁，然后在执行完毕后释放掉这个内在锁。</p>
</blockquote>
<p>代码执行到 <code>monitorenter</code> 指令，说明开始进入 <code>synchronized</code> 代码块，这时候 JVM 会尝试获取这个对象的 <code>monitor</code> 所有权，即尝试加锁；而执行到 <code>monitorexit</code> 指令，就说明要么 <code>synchronized</code> 代码块执行完毕，要么代码执行的时候抛出了异常，这时候 JVM 就会释放这个对象的 <code>monitor</code> 所有权，即释放锁。</p>
<h2 id="继续深入细节"><a href="#继续深入细节" class="headerlink" title="继续深入细节"></a>继续深入细节</h2><p>上面说的也是云里雾里的，咱继续往深处挖，看看具体的实现。</p>
<p><code>Monitor</code> 这个东西，看 Java 源码找不到，得找虚拟机的 C++ 源码。比如我们常用的 HotSpot 虚拟机中，<code>Monitor</code> 是由 <code>ObjectMonitor</code> 类实现的：</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为了解释方便，仅抄录了相关的代码，并重排了位置</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectMonitor</span> {</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">ObjectMonitor</span>() {</span><br><span class="line">            _header       = <span class="literal">NULL</span>;</span><br><span class="line">            _count        = <span class="number">0</span>;</span><br><span class="line">            _waiters      = <span class="number">0</span>,</span><br><span class="line">            _recursions   = <span class="number">0</span>;</span><br><span class="line">            _object       = <span class="literal">NULL</span>;</span><br><span class="line">            _owner        = <span class="literal">NULL</span>;</span><br><span class="line">            _WaitSet      = <span class="literal">NULL</span>;</span><br><span class="line">            _WaitSetLock  = <span class="number">0</span> ;</span><br><span class="line">            _Responsible  = <span class="literal">NULL</span> ;</span><br><span class="line">            _succ         = <span class="literal">NULL</span> ;</span><br><span class="line">            _cxq          = <span class="literal">NULL</span> ;</span><br><span class="line">            FreeNext      = <span class="literal">NULL</span> ;</span><br><span class="line">            _EntryList    = <span class="literal">NULL</span> ;</span><br><span class="line">            _SpinFreq     = <span class="number">0</span> ;</span><br><span class="line">            _SpinClock    = <span class="number">0</span> ;</span><br><span class="line">            OwnerIsThread = <span class="number">0</span> ;</span><br><span class="line">            _previous_owner_tid = <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="keyword">volatile</span> <span class="type">intptr_t</span>  _count;          <span class="comment">// reference count to prevent reclaimation/deflation</span></span><br><span class="line">                                            <span class="comment">// at stop-the-world time.  See deflate_idle_monitors().</span></span><br><span class="line">                                            <span class="comment">// _count is approximately |_WaitSet| + |_EntryList|</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待锁的线程会被封装成ObjectWaiter对象</span></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        <span class="type">void</span> *  <span class="keyword">volatile</span> _owner;                <span class="comment">// 一个指针，指向当前拥有锁的线程</span></span><br><span class="line">        ObjectWaiter * <span class="keyword">volatile</span> _WaitSet;       <span class="comment">// 一个队列，保存着waiting状态的线程</span></span><br><span class="line">        ObjectWaiter * <span class="keyword">volatile</span> _EntryList ;    <span class="comment">// 一个队列，保存着因等待锁而被阻塞的线程</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>当多个线程同时访问一段 <code>synchronized</code> 代码时，会发生这些操作：</p>
<ul>
<li>线程首先会进入<code>_EntryList</code>，在该线程获取到对象的 <code>monitor</code> 之后，<code>_owner</code> 会指向这个线程，然后<code>_count</code> 计数器加一。<ul>
<li>如果得到 <code>monitor</code> 的这个线程调用了 <code>wait()</code> 方法，那么这个线程将会释放掉 monitor 的所有权，<code>_owner</code> 变量变回 NULL，<code>_count</code> 计数器也会减一，同时这个线程会进入<code>_WaitSet</code> 等待被唤醒。</li>
<li>如果这个线程执行完毕，那么它也将释放 <code>monitor</code>，并复位<code>_count</code> 的值，这样其他的线程也就可以获得 <code>monitor</code> 来加锁了。</li>
</ul>
</li>
<li>上一个线程释放掉 <code>monitor</code> 后，<code>_EntryList</code> 中的线程就会开始争抢 <code>monitor</code>，具体哪个线程能成功得到 <code>monitor</code> 是不确定的。</li>
</ul>
<p>而正因为 Monitor 对象存在于每个 Java 对象头的 <code>mark word</code> 中，所以每个 Java 对象都可以用作锁。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9keW1hbnp5LmdpdGh1Yi5pby8yMDE3LzA4LzA3L3N5bmNocm9uaXplZCVFNCVCOCU4RSVFNSVBRiVCOSVFOCVCMSVBMSVFNyU5QSU4NE1vbml0b3Iv">synchronized 与对象的 Monitor<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlL3R1dG9yaWFsL2Vzc2VudGlhbC9jb25jdXJyZW5jeS9sb2Nrc3luYy5odG1s">Intrinsic Locks and Synchronization<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82ODQ0OTAzNjQwMTk3NTEzMjMw">啃碎并发（七）：深入分析 Synchronized 原理<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0pldEJyYWlucy9qZGs4dV9ob3RzcG90L2Jsb2IvbWFzdGVyL3NyYy9zaGFyZS92bS9ydW50aW1lL29iamVjdE1vbml0b3IuaHBwI0wxNDQtTDE2Mg==">objectMonitor.hpp - JetBrains/jdk8u_hotspot<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTY1NTU1NDIvd2h5LWRvLXdlLW5lZWQtdG8tY2FsbC1tb25pdG9yZXhpdC1pbnN0cnVjdGlvbi10d2ljZS13aGVuLXdlLXVzZS1zeW5jaHJvbml6ZWQ=">Why do we need to call ‘monitorexit’ instruction twice when we use ‘synchronized’ keyword? - StackOverflow<i class="fa fa-external-link-alt"></i></span></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer"><img src="https://blog-static.boris1993.com/CodeLifeOfBorisBanner.png" />
<br>
<!-- bottom ad -->
<div class="post-body-adsense" style="text-align: center;">
     <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-1056823357231661"
          data-ad-slot="5274622882"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
     <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
     </script>
</div>

          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="https://blog-static.boris1993.com/reward/wechatpay.png" alt="Boris Zhao 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="https://blog-static.boris1993.com/reward/alipay.jpg" alt="Boris Zhao 支付宝">
        <span>支付宝</span>
      </div>
      <div>
        <img src="https://blog-static.boris1993.com/reward/bitcoin.png" alt="Boris Zhao 比特币">
        <span>比特币</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98/" rel="tag"># 面试问题</a>
              <a href="/tags/syncronized/" rel="tag"># syncronized</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/building-a-sms-forwarder-with-air780e.html" rel="prev" title="100 块自制短信转发器">
                  <i class="fa fa-angle-left"></i> 100 块自制短信转发器
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/java-how-to-wait-for-threads-before-continuing.html" rel="next" title="在 Java 中如何实现在多个线程全部完成后再执行后续的代码">
                  在 Java 中如何实现在多个线程全部完成后再执行后续的代码 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Boris Zhao</span>
  </div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9waXNjZXMv">NexT.Pisces</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.24.0/algoliasearch-lite.umd.js" integrity="sha256-b2n6oSgG4C1stMT/yc/ChGszs9EY/Mhs6oltEjQbFCQ=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>



  




<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://valine-api.boris1993.com","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":true,"locale":{"placeholder":"说点什么"},"comment_count":true,"el":"#waline","comment":true,"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","path":"/how-synchronized-works-in-java.html"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
